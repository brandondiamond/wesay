source ./common

SERVER=

function cleanup {
	# hideous but i'll fix this later
	kill -KILL $(ps aux | grep wesay-server | tr -s ' ' | cut -d' ' -f2) > /dev/null 2>&1
	
	#if "$SERVER"; then
	#	kill -KILL $SERVER
	#fi	
}

trap cleanup EXIT

echo "WARNING: everything you write is committed to a public repo. Also, this script utilizes git so make sure your working directory is clean (^C to exit)."

echo "> Starting server..."
./wesay-server 2>/dev/null &
SERVER="$!"
echo "> Started ($SERVER)"

while true; do
	read -p "say> " msg
	echo "> Scheduling message..."

	git stash > /dev/null 2>&1

	let -i now=$(get_time)
	let -i ts=$((now + PAUSE))
	
	echo "$ts $msg" >> message

	git add message > /dev/null 2>&1
	git commit -m "Automatic message commit" > /dev/null 2>&1
	yes y | git push > /dev/null 2>&1

	git stash pop > /dev/null 2>&1
	echo "> Scheduled!"
done
